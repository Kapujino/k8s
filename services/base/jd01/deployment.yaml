---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jd01
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    spec:
      containers:
        - name: jd01
          image: ghcr.io/kapujino/docker-jdownloader2:arm64
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              log(){ printf '%s %s\n' "$(date -Is)" "$*" >&2; }

              log "wrapper: starting /opt/scripts/start.sh in background"
              /opt/scripts/start.sh & start_sh_pid=$!
              log "wrapper: start.sh pid=$start_sh_pid"

              # Wait up to 300s for java to appear; fallback to start_sh_pid
              for i in $(seq 1 600); do
                jpid=$(pidof java || true)
                if [ -n "$jpid" ]; then
                  log "wrapper: detected java pid=$jpid"
                  break
                fi
                log "wrapper: waiting for java to start ($i/600)"
                sleep 1
              done
              if [ -z "$jpid" ]; then
                jpid=$start_sh_pid
                log "wrapper: java not found, falling back to start_sh_pid=$jpid"
              fi

              # SIGTERM handler: forward SIGTERM to Java and wait up to 300s
              trap 'log "wrapper: SIGTERM received, forwarding to java"; jpid=$(pidof java || true); if [ -n "$jpid" ]; then log "wrapper: killing java pid=$jpid"; kill -SIGTERM $jpid || log "wrapper: kill failed"; else log "wrapper: no java pid to kill"; fi; for j in $(seq 1 300); do if [ -z "$(pidof java)" ]; then log "wrapper: java exited after ${j} seconds"; exit 0; else log "wrapper: waiting for java to exit (${j}/300)"; sleep 1; fi; done; log "wrapper: grace period expired, exiting 143"; exit 143' SIGTERM

              log "wrapper: blocking as PID 1 until pid $jpid exits"
              tail --pid=$jpid -f /dev/null

              # workaround - removes trap code
              exec sleep infinity
          ports:
          - containerPort: 5900
            name: jd-tcp
            protocol: TCP
          - containerPort: 5900
            name: jd-udp
            protocol: UDP
          envFrom:
            - configMapRef:
                name: jd01-env
          volumeMounts:
          - mountPath: /jDownloader2
            name: jd-config-volume
          - mountPath: /downloads
            name: downloads-volume
          - mountPath: /watch
            name: jd-watch-volume
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    log(){ printf '%s %s\n' "$(date -Is)" "$*" >&2; }
                    log "preStop: initiated"

                    jpid=$(pidof java || true)
                    if [ -n "$jpid" ]; then
                      log "preStop: found java pid=$jpid, sending SIGTERM"
                      kill -SIGTERM $jpid || log "preStop: kill returned $?"
                    else
                      log "preStop: no java pid found"
                    fi

                    # Wait up to 300s for java to exit
                    for i in $(seq 1 300); do
                      if [ -z "$(pidof java)" ]; then
                        log "preStop: java exited after $i seconds"
                        exit 0
                      fi
                      log "preStop: waiting for java to exit ($i/300)"
                      sleep 1
                    done

                    log "preStop: grace period expired, continuing shutdown"
                    exit 0
        - name: wg-jd01
          image: lscr.io/linuxserver/wireguard:1.0.20250521
          securityContext:
            capabilities:
              add:
              - NET_ADMIN
            privileged: true
          envFrom:
            - configMapRef:
                name: default-env-internal
          volumeMounts:
          - mountPath: /config
            name: wg-config-volume
          - mountPath: /lib/modules #wg kernel module
            name: lib-modules
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - rp4node01
      dnsPolicy: ClusterFirst
      volumes:
      - name: jd-config-volume
        nfs:
          server: 192.168.1.10
          path: /mnt/volumes/nfs/jd01/jd
          readOnly: false
      - name: downloads-volume
        hostPath:
          path: /mnt/downloads
          type: Directory
      - name: jd-watch-volume
        nfs:
          server: 192.168.1.10
          path: /mnt/volumes/nfs/jd01/watch
          readOnly: false
      - name: wg-config-volume
        nfs:
          server: 192.168.1.10
          path: /mnt/volumes/nfs/jd01/wg
          readOnly: false
      - name: lib-modules
        hostPath:
          path: /lib/modules

